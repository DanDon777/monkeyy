<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MONKEYY.APP ‚Äî Banana Board üçå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    body { background: #181820; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; }
    .main { max-width: 490px; margin: 30px auto 0 auto; padding: 18px 7px 110px 7px; background: #232346; border-radius: 23px; box-shadow: 0 6px 44px #0008; text-align: center; position: relative; }
    .logo { font-size: 2.4em; font-weight: 900; letter-spacing: 2px; color: #ffe46c; margin-bottom: 3px; margin-top: 9px; text-shadow: 0 4px 16px #d3ae0060; }
    .tagline { color: #5ff0c5; font-size: 1.14em; margin-bottom: 17px; font-weight: 600; letter-spacing: .01em;}
    .online-count { font-size: 1.14em; color: #55f191; margin-bottom: 10px; margin-top: 2px; display: flex; align-items: center; justify-content: center;}
    .online-dot { width: 15px; height: 15px; background: #11fdaf; border-radius: 50%; margin-right: 7px; box-shadow:0 0 12px #11fdaf80; animation: onlinepulse 1.3s infinite alternate;}
    @keyframes onlinepulse { 0%{box-shadow:0 0 12px #11fdaf80;} 100%{box-shadow:0 0 25px #22fcc780;} }
    .nickname-box { display:flex;justify-content:center;align-items:center;gap:7px;margin-bottom:11px;}
    .nickname-input { padding: 11px; font-size: 1.07em; border-radius: 9px; border: none; width: 80%; background: #26274a; color: #ffe46c; font-weight: bold; }
    .nickname-btn { padding: 7px 10px; border-radius: 8px; border:none; font-weight:bold; background: #55f191; color: #232346; margin-left:2px; cursor:pointer;}
    .nickname-btn.random { background: #ffe46c; }
    .nickname-timer { color: #5ff0c5; font-size: 0.92em; margin-top: 2px;}
    .red-warning {color: #ff6767; font-weight: bold; margin-top:7px; margin-bottom:2px; min-height:18px; transition:opacity .5s;}
    .red-warning.hide { opacity: 0; pointer-events: none; transition:opacity .5s;}
	.prank-action-btn:disabled {
	  filter: grayscale(0.5) brightness(0.8);
	  cursor: not-allowed;
	  opacity: 0.7;
	}

    .avatar-profile { font-size: 2.2em; margin-right: 8px; vertical-align: middle; transition:.18s;}
    .avatar-profile.flex { animation:flexbump 0.7s;}
    @keyframes flexbump { 0%{transform:scale(1);} 40%{transform:scale(1.34) rotate(-10deg);} 60%{transform:scale(1.17) rotate(8deg);} 100%{transform:scale(1);} }
    .streakbar { margin: 13px 0 5px 0; color: #ffd84d; font-size: 1.04em; font-weight: 600; letter-spacing: .01em;}
    .levelbar { font-size: 0.96em; color: #ffd84d; margin-bottom: 2px;}
    .prank-box { background: #202037; border-radius: 17px; margin: 16px 0 10px 0; padding: 24px 8px 15px 8px; min-height: 114px; box-shadow: 0 2px 16px #2e396a33; position: relative;}
    .prank-icon { font-size: 2.1em; margin-bottom: 10px;}
    .prank-desc { font-size: 1.14em; color: #ffe46c; font-weight: bold; margin-bottom: 10px; line-height: 1.27; min-height: 44px;}
    .prank-meta { font-size: 0.99em; color: #89f9e6; margin-bottom: 3px;}
    .prank-btn-row { display: flex; justify-content: space-between; margin-top: 10px; gap: 9px;}
    .prank-action-btn { flex: 1; padding: 14px 0; border-radius: 12px; border: none; font-weight: bold; font-size: 1.06em; cursor: pointer; box-shadow: 0 2px 11px #19282030; transition: background 0.13s, color 0.11s, transform 0.11s;}
    .prank-action-btn.pranked { background: linear-gradient(90deg,#55f191,#16d3fa); color: #1a1930;}
    .prank-action-btn.pass { background: #3e3d60; color: #ffdf7a;}
    .prank-action-btn.pranked:hover { background: linear-gradient(90deg,#16d3fa,#55f191); color: #fff; transform: scale(1.04);}
    .prank-action-btn.pass:hover { background: #232346; color: #ffd36e; transform: scale(1.04);}
    .again-btn { background: linear-gradient(90deg,#fbda61,#6cf4b5,#36c7ff); color: #232346; font-size: 1.04em; font-weight: bold; border: none; border-radius: 12px; box-shadow: 0 2px 12px #2e396abb; cursor: pointer; letter-spacing: 0.01em; transition: background 0.13s, color 0.12s, transform 0.11s; padding: 11px 10px; margin-top: 7px; margin-bottom: 2px;}
    .again-btn:hover { background: linear-gradient(90deg,#36c7ff,#fbda61,#6cf4b5); color: #232346; transform: scale(1.035);}
    .leader-title { color: #ffef82; font-weight: bold; margin-bottom: 5px; font-size: 1.09em; text-align: center;}


    .badge { padding:2px 8px; border-radius:10px; margin-left:5px; font-size:0.89em;}
	.badge.king {
	  background: #ffe46c;
	  color: #232346;
	  font-weight: bold;
	  animation: kingglow 1.6s infinite alternate;

	  box-shadow: 0 0 10px 3px #ffe46c77;
	  text-shadow: 0 0 4px #ffd84d99, 0 0 2px #fff1;
	}
	@keyframes kingglow {
	  0%   { box-shadow: 0 0 6px 2px #ffe46c77; opacity: 1; }
	  50%  { box-shadow: 0 0 16px 5px #ffe46cdd; opacity: 1; }
	  100% { box-shadow: 0 0 6px 2px #ffe46c77; opacity: 1; }
	}

	.badge.cuff {background:#ffb6f6;color:#232346;}
    .badge.legend {background:#ffb6f6;color:#232346;}
    .badge.goat {background:#8df7ff;color:#232346;}
    .badge.sussy {background:#ffde8a;color:#232346;}
    .badge.ratio {background:#98ffe0;color:#232346;}
    .badge.kitten {background:#e5bfff;color:#232346;}
    .badge.npc {background:#b6c9fd;color:#232346;}
    .badge.downbad {background:#ccc;color:#232346;}
    .badge.ohio {background:#ffe46c;color:#232346;}
    .badge.loser {background:#bfc4e1;color:#555;}


    .avatar {font-size:1.4em;margin-right:2px;}
    .copyright { color: #999; font-size: 0.93em; text-align: center; margin: 28px 0 13px 0; opacity: 0.7;}


    .confetti {position:fixed;z-index:99;pointer-events:none;user-select:none;}
    /* Share modal styles */
    .share-modal-bg {
      position: fixed; left:0;top:0;width:100vw;height:100vh;background:#0008;z-index:1001;display: flex;justify-content: center;align-items: center;
      animation: fadein .18s;
    }
    @keyframes fadein {from{opacity:0}to{opacity:1}}
    .share-modal {
      background: #181820;
      border-radius: 19px;
      box-shadow: 0 4px 32px #000c;
      padding: 32px 28px 30px 28px;
      min-width: 300px;
      min-height: 260px;
      position: relative;
      text-align: center;
      z-index: 1002;
      animation: modalpop .28s;
    }
    @keyframes modalpop {0%{transform:scale(0.82);} 60%{transform:scale(1.07);} 100%{transform:scale(1);}}
    .share-modal .level-trophy { font-size: 2.2em; margin-bottom: 6px; animation: trophyglow 1s infinite alternate;}
    .share-modal .banana-confetti {position:absolute;left:0;top:0;width:100%;height:100%;z-index:-1;pointer-events:none;}
    @keyframes trophyglow {0%{text-shadow:0 0 8px #ffe46c;}100%{text-shadow:0 0 28px #ffe46c,0 0 12px #fbda61;}}
    .share-modal-btns {margin-top:15px; display: flex; flex-direction: column; gap: 11px;}
    .share-modal-btns button {padding: 12px 0; border-radius: 11px; border:none;font-size:1.1em; font-weight:bold; cursor:pointer; transition: background 0.11s;}
    .share-modal-btns .x {background:#222f4a;color:#ffe46c;}
    .share-modal-btns .x:hover {background:#1a1e3a;color:#ffe46c;}
    .share-modal-btns .link {background:#1de6a1;color:#1c2539;}
    .share-modal-btns .link:hover {background:#ffe46c;color:#1c2539;}
    .share-modal-btns .download {background:#6cf4b5;color:#1c2539;}
    .share-modal-btns .download:hover {background:#ffe46c;color:#1c2539;}
    .share-modal-btns .copyimg {background:#fbda61;color:#222;}
    .share-modal-btns .copyimg:hover {background:#ffe46c;color:#232346;}
    .share-modal-btns .copytext {background:#36c7ff;color:#181820;}
    .share-modal-btns .copytext:hover {background:#ffe46c;color:#181820;}
    .share-modal-close { position:absolute;right:20px;top:13px;font-size:2em;background:none;border:none;color:#ffd84d;cursor:pointer; }
    .share-toast {
      position: fixed;
      left: 50vw;
      bottom: 8vh;
      transform: translateX(-50%);
      background: #232346;
      color: #ffe46c;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1.15em;
      padding: 14px 26px;
      z-index: 2001;
      opacity: 0.95;
      box-shadow: 0 2px 22px #000c;
      animation: fadein .16s;
    }
    @media (max-width: 520px) {
      .main { max-width: 99vw; padding: 3vw 1vw 18vw 1vw;}
      .logo { font-size: 2em; }
      .prank-box { padding: 10px 3vw 7px 3vw;}
      .prank-desc { font-size: 1em;}
      .prank-icon { font-size: 1.4em; }
      .streakbar { font-size: 0.98em;}
      .levelbar { font-size: 0.88em;}

	#leaderboardSticky {
	  display: flex;
	  justify-content: center;
	  padding-bottom: env(safe-area-inset-bottom, 0);
	}
	.leaderboard-container {
	  width: 96vw; max-width: 560px;
	  margin: 0 auto 12px auto;
	  background: rgba(36,39,67, 0.97);
	  border-radius: 22px 22px 16px 16px;
	  box-shadow: 0 12px 38px #000b, 0 2px 18px #3b338770;
	  padding: 11px 8px 6px 8px;
	  pointer-events: all;
	  animation: lbpop .37s cubic-bezier(.6,-0.35,.3,1.4);
	}
	@keyframes lbpop { 0%{transform:translateY(40px) scale(.93);opacity:0;} 100%{transform:translateY(0) scale(1);opacity:1;} }
	.leaderboard-row {
	  display: flex;
	  align-items: center;
	  gap: 11px;
	  background: rgba(49,54,94, 0.81);
	  border-radius: 12px;
	  margin-bottom: 6px;
	  padding: 7px 14px 7px 12px;
	  box-shadow: 0 2px 9px #0002;
	  font-size: 1.09em;
	  position: relative;
	  transition: background .2s;
	}
	.leaderboard-row.top1 {
	  background: linear-gradient(90deg, #ffe46c33 0%, #ffef8240 80%, #ffe46c14 100%);
	  box-shadow: 0 4px 26px #ffe46c33, 0 2px 18px #ffd84d33;
	  font-weight: bold;
	  border: 2px solid #ffe46cbb;
	}
	.leaderboard-row.your {
	  border: 2px solid #55f191cc;
	  background: linear-gradient(90deg,#223b30cc 0%, #55f19140 100%);
	}
	.leaderboard-row .avatar {
	  font-size: 1.5em;
	  margin-right: 3px;
	}
	.leaderboard-row .spot {
	  min-width: 2em;
	  text-align: center;
	  font-size: 1.2em;
	  color: #ffe46c;
	}
	.leaderboard-row .name {
	  font-weight: 700;
	  letter-spacing: 0.01em;
	  margin-right: 6px;
	  color: #fff5c8;
	}
	.leaderboard-row .badge {
	  padding: 1px 9px;
	  border-radius: 10px;
	  font-size: .90em;
	  font-weight: bold;
	  margin-right: 4px;
	  margin-left: 2px;
	}
	.badge.you { background: #55f191; color: #212633;}
	.badge.king { background: #ffe46c; color: #232346; box-shadow: 0 0 7px #ffe46c80;}
	.leaderboard-row .meta {
	  margin-left: auto;
	  display: flex;
	  align-items: center;
	  gap: 13px;
	  font-size: .96em;
	}
	.leaderboard-row .meta span {
	  color: #98ffe0;
	  background: #22293b;
	  border-radius: 6px;
	  padding: 0 7px;
	  font-weight: 500;
	}
	.leaderboard-row .meta .level { color: #ffd84d; background: #232346;}
	.leaderboard-row .meta .xp { color: #ffb6f6; background: #232346;}
	.leaderboard-row .meta .streak { color: #55f191; background: #232346;}
	.leaderboard-row .share-btn {
	  margin-left: 10px;
	  padding: 3px 13px;
	  border-radius: 8px;
	  background: linear-gradient(90deg,#55f191,#ffe46c);
	  color: #1c222e;
	  font-weight: 600;
	  font-size: .98em;
	  border: none;
	  cursor: pointer;
	  transition: background .13s, color .13s, box-shadow .13s;
	  box-shadow: 0 2px 6px #16182026;
	}
	.leaderboard-row .share-btn:hover {
	  background: linear-gradient(90deg,#ffe46c,#55f191);
	  color: #181820;
	}
	@media (max-width: 540px) {
	  .leaderboard-container { padding: 7px 3px 3vw 3px; }
	  .leaderboard-row { font-size: .98em; padding: 6px 4vw 6px 3vw; }
	}

      .main {padding-bottom:34vh;}
      .share-modal {min-width:94vw;}
    }
    @keyframes fadeout { from{opacity:1;} to{opacity:0;} }
	@keyframes confettifall {
	  from { transform: translateY(0); opacity: .85; }
	  to   { transform: translateY(240px); opacity: 0.13; }
	}

	.share-emoji {
	  font-size: 1.55em;
	  cursor: pointer;
	  opacity: 0.92;
	  filter: drop-shadow(0 0 7px #ffe46c90);
	  position: relative;
	  transition: transform 0.1s;
	  outline: none;
	}
	.share-emoji:hover, .share-emoji:focus {
	  transform: scale(1.15);
	}
	.share-emoji .tooltip {
	  visibility: hidden;
	  opacity: 0;
	  width: 125px;
	  background: #232346;
	  color: #ffe46c;
	  border: 1.5px solid #ffe46c;
	  border-radius: 8px;
	  text-align: center;
	  font-size: 0.5em;
	  font-weight: 600;
	  padding: 7px 0;
	  position: absolute;
	  left: 50%; top: 130%;
	  transform: translateX(-50%);
	  z-index: 10;
	  transition: opacity 0.17s;
	  pointer-events: none;
	  box-shadow: 0 4px 18px #0006;
	}
	.share-emoji:hover .tooltip,
	.share-emoji:focus .tooltip {
	  visibility: visible;
	  opacity: 1;
	}
	
  </style>
  <!-- SOUNDS -->
  <audio id="soundLevelUp" src="/assets/audio/levelup.mp3" preload="auto"></audio>
  <audio id="soundPranked" src="/assets/audio/pranked.mp3" preload="auto"></audio>
  <audio id="soundPass" src="/assets/audio/pass.mp3" preload="auto"></audio>
  <audio id="soundMonkey1" src="/assets/audio/monkey1.mp3" preload="auto"></audio>
  <audio id="soundMonkey2" src="/assets/audio/monkey2.mp3" preload="auto"></audio>
  <!-- html2canvas for screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, query, orderByChild, limitToLast, get, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
	import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    window.FirebaseMod = { initializeApp, getDatabase, ref, set, query, orderByChild, limitToLast, get, onValue, serverTimestamp, getAuth, signInAnonymously, onAuthStateChanged };
  </script>
  <script defer data-domain="monkeyy.app" src="https://plausible.io/js/script.js"></script>
</head>
<body>
  <div class="main">
    <div class="logo">MONKEYY.APP</div>
    <div class="tagline">Grind the board, prank your way to Banana King. <span style="color:#ffd84d">üçå</span></div>
    <div class="online-count"><span class="online-dot"></span><span id="onlineNum">Online: ...</span></div>
    <!-- Nickname UI and avatar -->
    <div class="nickname-box">
      <span id="avatarProfile" class="avatar-profile">üçºüôä</span>
      <input id="nicknameInput" class="nickname-input" maxlength="16" autocomplete="off" spellcheck="false" placeholder="Pick your nickname">
      <button id="nickRandomBtn" class="nickname-btn random" title="Random nickname">üé≤</button>
      <button id="nickSaveBtn" class="nickname-btn" title="Save">Save</button>
    </div>
    <div id="nicknameWarn" class="red-warning" style="display:none;"></div>
    <div id="nicknameTimer" class="nickname-timer"></div>
    <div id="streakArea" class="streakbar"></div>
    <div id="levelArea" class="levelbar"></div>
    <div id="prankArea"></div>
    <div id="startArea">
      <button class="again-btn" id="startBtn">START PRANK ROULETTE</button>
      <div style="margin-top:12px; color:#ffe46c; font-size:1.05em;">
        <b>üíÄ Only the wildest make the banana board.<br> King resets every day.</b>
      </div>
    </div>
	<!-- Share Emoji Block, centered below -->
	<div style="display: flex; justify-content: center; margin-top: 18px; margin-bottom: -2px;">
	  <span class="share-emoji" tabindex="0"
			onclick="navigator.clipboard.writeText(window.location.href); this.innerText='‚úÖ'; setTimeout(()=>this.innerText='üîó',900);">
		üîó
		<span class="tooltip">Copy game link!</span>
	  </span>
	  <span id="soundToggle" class="share-emoji" tabindex="0" title="Mute/Unmute Sounds" onclick="toggleSound()">
		üîä
		<span class="tooltip">Mute/Unmute Sound</span>
	  </span>
	</div>
  <div id="leaderboardSticky"></div>
  </div>

  <div id="footer" class="copyright">
    Monkeyy.app is not affiliated with monkey.app.<br>
    For entertainment only. Grind responsibly.
  </div>
  <div id="shareModalMount"></div>
  <script type="module">
	// --- SOUND MUTE TOGGLE ---
	let isMuted = localStorage.getItem("bananaMuted") === "1";

	function toggleSound() {
	  isMuted = !isMuted;
	  localStorage.setItem("bananaMuted", isMuted ? "1" : "0");
	  document.getElementById("soundToggle").innerText = isMuted ? "üîá" : "üîä";
	}

	// On DOM load, set correct emoji:
	document.addEventListener('DOMContentLoaded', () => {
	  document.getElementById("soundToggle").innerText = isMuted ? "üîá" : "üîä";
	});
	window.toggleSound = toggleSound;
    // -- Firebase imports
	const { initializeApp, getDatabase, ref, set, query, orderByChild, limitToLast, get, onValue, serverTimestamp, getAuth, signInAnonymously, onAuthStateChanged } = window.FirebaseMod;
    // -- Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA61PrIFb6kSauhP0I2Q2xxR6q99Agjzak",
      authDomain: "monkeyyapp.firebaseapp.com",
      databaseURL: "https://monkeyyapp-default-rtdb.firebaseio.com",
      projectId: "monkeyyapp",
      storageBucket: "monkeyyapp.firebasestorage.app",
      messagingSenderId: "511090448930",
      appId: "1:511090448930:web:197287ce764a0c4d80087b",
      measurementId: "G-F0DHGBFY50"
    };
	const app = initializeApp(firebaseConfig);
	const db = getDatabase(app);
	const auth = getAuth(app);

	let currentUid = null;
	let banCheckInterval = null;

	// Start anonymous sign-in (no login UI!)
	signInAnonymously(auth);

	// All UID-dependent actions go here:
	onAuthStateChanged(auth, user => {
	  if (user) {
		currentUid = user.uid;
		dailyResetIfNeeded();
		setInterval(updatePresence, 30000);

		// Now safe to call things that need UID:
		updatePresence();
		watchOnlineUsers();

		// Start the shadowban check interval ONCE:
		if (!banCheckInterval) {
		  banCheckInterval = setInterval(() => {
			getFirebaseShadowbanUntil(deviceId).then(until => {
			  if (until > shadowbanUntil) {
				shadowbanUntil = until;
				localStorage.setItem("bananaShadowbanUntil", until);
				if (Date.now() < shadowbanUntil) shadowbanTimerTick();
			  }
			});
		  }, 30000);
		}

		// ===== ADD THIS HERE: Fetch shadowban at login! =====
		getFirebaseShadowbanUntil(deviceId).then(until => {
		  if (until > shadowbanUntil) {
			shadowbanUntil = until;
			localStorage.setItem("bananaShadowbanUntil", until); // Sync local for speed
		  }
		  if (Date.now() < shadowbanUntil) shadowbanTimerTick();
		});
		// ========================================
	  }
	});
	
	// --- SHADOWBAN: Firebase helpers ---
	async function getFirebaseShadowbanUntil(deviceId) {
	  const snap = await get(ref(db, `bans/${currentUid}`));
	  if (snap.exists() && snap.val().until > Date.now()) {
		return snap.val().until;
	  }
	  return 0;
	}

	async function setFirebaseShadowban(deviceId, until, reason = "bot") {
	  await set(ref(db, `bans/${currentUid}`), { until, reason });
	}


    // -- Utility: Get today/yesterday as leaderboard key
    function getDayKey(ts = Date.now()) {
      const d = new Date(ts);
      return d.getUTCFullYear() + '-' + String(d.getUTCMonth()+1).padStart(2,'0') + '-' + String(d.getUTCDate()).padStart(2,'0');
    }
    const todayKey = getDayKey();
    const yesterdayKey = getDayKey(Date.now()-86400000);

	dailyResetIfNeeded();

    // -- Nickname, anti-abuse, random name/avatars
    const BANNED_WORDS = [
      /nigg/i, /fag/i, /retard/i, /monkey\.app/i, /admin/i, /fuck/i, /shit/i, /bitch/i, /cunt/i, /hitler/i, /mod/i, /owner/i
    ];
    function cleanNickname(name) {
      for(let w of BANNED_WORDS) if(w.test(name)) return false;
      return /^[a-zA-Z0-9 _\-]{3,16}$/.test(name);
    }
    function randomNickname() {
      const animals = ['Orangutan','Gibbon','Baboon','Macaque','Capuchin','Mandrill','Gorilla','Lemur','Saki','Howler','Uakari','Langur','Spider','Squirrel','Marmoset'];
      const adj = ['Drippy','Sus','NPC','Downbad','Banana','Ratio','Clouted','Ohio','Sturdy','Glitched','NoRizz','Alt','AFK','Based','Fruity','Pepe','Speedy','Sigma','Toxic'];
      return adj[Math.floor(Math.random()*adj.length)] + animals[Math.floor(Math.random()*animals.length)] + Math.floor(10+Math.random()*90);
    }
	// Check if nickname is already used today by another user
	async function isNicknameTakenToday(nick) {
	  const snap = await get(ref(db, 'leaderboard/' + todayKey));
	  let taken = false;
	  snap.forEach(child => {
		const data = child.val();
		// Allow your own name, block if taken by others
		if (data.nickname && data.nickname.toLowerCase() === nick.toLowerCase() && child.key !== currentUid) {
		  taken = true;
		}
	  });
	  return taken;
	}

    function getRankAvatar(rank) {
      if(rank=="Cuff")             return '<img src="/assets/emoji/cuff1.png" alt="Cuff" style="width:1.4em;height:1.4em;vertical-align:middle;">';
      if(rank=="Banana King")      return "üëëü¶ç";
      if(rank=="Clout Demon")      return "üòàü¶ç";
      if(rank=="Speedrunner")      return "üêíüí®";
      if(rank=="Discord Kitten")   return "üê±";
      if(rank=="NPC Mod")          return "üíªü¶ß";
      if(rank=="Ohio Legend")      return "ü¶¶";
      if(rank=="Sussy Baka")       return "ü´•üêµ";
      if(rank=="Ratio Demon")      return "üìâüôà";
      if(rank=="Rizzler")          return "üòèü¶ç";
      if(rank=="Down Bad")         return "ü•≤üôä";
      return "üçºüôä";
    }
    // -- DeviceID: unique to your browser
    function getDeviceId() {
      let id = localStorage.getItem("bananaId");
      if (!id) {
        id = "dev"+Math.random().toString(36).slice(2,11)+Date.now().toString(36);
        localStorage.setItem("bananaId",id);
      }
      return id;
    }
    const deviceId = getDeviceId();

	// ================= DAILY RESET FUNCTION ===================
	async function dailyResetIfNeeded() {
	  const savedDayKey = localStorage.getItem("bananaLastDayKey");
	  if (savedDayKey !== todayKey) {
		localStorage.removeItem("bananaState");
		localStorage.setItem("bananaLastDayKey", todayKey);

		if (currentUid) {
		  await clearLeaderboardEntry();
		} else {
		  let _check = setInterval(() => {
			if (currentUid) {
			  clearLeaderboardEntry();
			  clearInterval(_check);
			}
		  }, 120);
		}
	  }
	}

    // -- Nickname: only once per 24h, 3 changes per day!
    function nicknameChangeAllowed() {
      const first = +(localStorage.getItem("bananaNickChangeFirstTime")||0);
      const count = +(localStorage.getItem("bananaNickChangeCount")||0);
      if(!first || Date.now()-first > 86400000) {
        localStorage.setItem("bananaNickChangeFirstTime", Date.now());
        localStorage.setItem("bananaNickChangeCount", 0);
        return true;
      }
      return count < 3;
    }
    function nicknameChangeWaitTime() {
      const first = +(localStorage.getItem("bananaNickChangeFirstTime")||0);
      const left = 86400000-(Date.now()-first);
      if(left <= 0) return 0;
      return left;
    }
    function showNicknameTimer() {
      if (nicknameChangeAllowed()) {
        document.getElementById('nicknameTimer').innerHTML = "<b>‚úîÔ∏è You can change your nickname (3x per day).</b>";
        document.getElementById('nicknameInput').disabled = false;
        document.getElementById('nickRandomBtn').disabled = false;
        document.getElementById('nickSaveBtn').disabled = false;
        return;
      }
      const left = nicknameChangeWaitTime();
      const h = Math.floor(left/3600000), m = Math.floor((left%3600000)/60000), s = Math.floor((left%60000)/1000);
      document.getElementById('nicknameTimer').innerHTML = `‚è≥ Nickname locked for <b>${h}h ${m}m ${s}s</b>`;
      document.getElementById('nicknameInput').disabled = true;
      document.getElementById('nickRandomBtn').disabled = true;
      document.getElementById('nickSaveBtn').disabled = true;
    }
    setInterval(showNicknameTimer, 1000);

	async function clearLeaderboardEntry() {
	  await set(ref(db, `leaderboard/${todayKey}/${currentUid}`), {
		nickname: "",
		streak: 0,
		xp: 0,
		level: 1,
		high: 0,
		time: 0,
		avatar: getRankAvatar("Peasant"),
		rank: "Peasant"
	  });
	}
    function resetAllProgress() {
      state = {xp:0, streak:0, level:1, high:0, avatar: getRankAvatar("Peasant"), rank: "Peasant"};
      passCount = 0; botStrikes = 0; lastPrankedAt = 0;
      saveLocal();
      updateBars();
      clearLeaderboardEntry();
      updateAvatarUI();
    }

    // -- GAME STATE
    let state = JSON.parse(localStorage.getItem("bananaState") || "{}");
    if(!state.xp) state = {xp:0, streak:0, level:1, high:0, avatar: getRankAvatar("Peasant"), rank: "Peasant"};
    let nickname = localStorage.getItem("bananaNick") || randomNickname();
    let avatar = getRankAvatar(state.rank || "Peasant");
    document.getElementById('nicknameInput').value = nickname;
    document.getElementById('avatarProfile').textContent = avatar;
    showNicknameTimer();

	async function setNicknameUI(val) {
	  if (!nicknameChangeAllowed()) {
		showWarn("Only 3 changes per 24h!", 2500);
		return;
	  }
	  if (!cleanNickname(val)) {
		showWarn("That nickname isn't allowed. 3-16 chars, letters/numbers only.", 2500);
		return;
	  }

	  // **ADDED: Check for taken nickname (except by yourself)**
	  if (await isNicknameTakenToday(val)) {
		showWarn("That nickname is already taken today.", 3000);
		return;
	  }

	  // Only reset if nickname actually changes!
	  if (val !== nickname) {
		// Increment change count and set time
		const first = +(localStorage.getItem("bananaNickChangeFirstTime")||0);
		let count = +(localStorage.getItem("bananaNickChangeCount")||0);
		if(!first || Date.now()-first > 86400000) {
		  localStorage.setItem("bananaNickChangeFirstTime", Date.now());
		  count = 0;
		}
		localStorage.setItem("bananaNickChangeCount", count+1);
		nickname = val;
		avatar = getRankAvatar("Peasant");
		localStorage.setItem("bananaNick", val);
		localStorage.setItem("bananaAvatar", avatar);
		document.getElementById('nicknameInput').value = val;
		resetAllProgress(); // Only reset when the name is actually different!
	  }
	  showNicknameTimer();
	  showLeaderboard();
	  updateAvatarUI();
	}

    function updateAvatarUI(flex = false) {
      avatar = getRankAvatar(state.rank);
      const prof = document.getElementById('avatarProfile');
      prof.innerHTML = avatar;
      if (flex) {
        prof.classList.add('flex');
        setTimeout(()=>prof.classList.remove('flex'), 800);
      }
    }
    document.getElementById('nicknameInput').value = nickname;
	document.getElementById('nickRandomBtn').onclick = async ()=>{ await setNicknameUI(randomNickname()); };
	document.getElementById('nickSaveBtn').onclick = async ()=>{ await setNicknameUI(document.getElementById('nicknameInput').value.trim()); };
	document.getElementById('nicknameInput').addEventListener('keydown', async e=>{
	  if(e.key==='Enter') await setNicknameUI(document.getElementById('nicknameInput').value.trim());
	});

    // -- Pranks
    const pranks = [
      {icon:"üíÄ", desc:"Speedrun getting muted. Narrate it.", meta:"Ban Speedrun"},
	  {icon:"ü§°", desc:"Troll as a different ethnicity/nationality for one minute.", meta:"Method Actor"},
	  {icon:"ü¶ç", desc:"Go full monkey. No context. Chest beating mandatory.", meta:"Primal Instinct"},
	  {icon:"üçå", desc:"Try to get banned from TikTok in under a minute. Bonus if you actually do.", meta:"Banana Ban"},
	  {icon:"üôä", desc:"Say the edgiest joke you know. Finish with ‚Äòjust a prank, bro!‚Äô", meta:"Joke Criminal"},
	  {icon:"üò¨", desc:"Ask: ‚ÄòCan you say the N-word?‚Äô‚Äîbut you mean ‚ÄòNinja‚Äô.", meta:"Bait and Switch"},
	  {icon:"üí•", desc:"Tell a dark joke.", meta:"Dark Comedian"},
	  {icon:"ü§´", desc:"Try to get the other person to expose a secret.", meta:"Truth Seeker"},
	  {icon:"üçë", desc:"Flirt with the other person using only fruity words.", meta:"Fruit Flirt"},
	  {icon:"ü¶ç", desc:"Go full ape for 15 seconds.", meta:"Ape Legend"},
	  {icon:"üëª", desc:"Pretend you got swatted mid-call.", meta:"Swat Bait"},
	  {icon:"ü§†", desc:"Debate if pineapple belongs on pizza. Make it a war.", meta:"Food Fight"},
	  {icon:"üòé", desc:"Try to act like Speed for a full minute.", meta:"Speed Clone"},
	  {icon:"ü•∑", desc:"Use an accent and pretend you're from a hood.", meta:"Mystery Agent"},
	  {icon:"ü§ñ", desc:"Glitch out like an IRL NPC.", meta:"IRL Glitch"},
	  {icon:"üòè", desc:"Imitate the most annoying streamer you know.", meta:"Annoyance Pro"},
	  {icon:"üé≤", desc:"Invent a new TikTok trend on the spot.", meta:"Trendsetter"},
	  {icon:"üé§", desc:"Make your best apology call to someone close to you.", meta:"Sorry Not Sorry"},
	  {icon:"üíÖ", desc:"Act extremely vain, like you‚Äôre live-streaming to 1M fans.", meta:"Diva Mode"},
	  {icon:"üíÄ", desc:"Say something IRL, that would get you a timeout (but don‚Äôt get arrested).", meta:"Viral Offender"},
	  {icon:"üî•", desc:"Drop your hottest, most controversial take. No filter.", meta:"Hot Take"},
	  {icon:"üóØÔ∏è", desc:"Start a fake fight about literally nothing. Commit 100%.", meta:"Drama Magnet"},
	  {icon:"üïµÔ∏è", desc:"Pretend you're in a secret cult, hint at forbidden knowledge.", meta:"Conspiracy Guru"},
	  {icon:"üé§", desc:"Roast the other person so hard even you cringe.", meta:"Roast Lord"},
	  {icon:"üî•", desc:"Drop the most controversial opinion you can, and defend it like it's life or death.", meta:"Flame Bait"},
	  {icon:"üê∏", desc:"Speak only in Kermit voice. Say disturbing facts.", meta:"Frog Cursed"},
	  {icon:"üîä", desc:"Repeat every word after someone, but louder and dumber.", meta:"Echo Menace"},
	  {icon:"üõë", desc:"Freeze mid-sentence and stare. Don‚Äôt blink.", meta:"Stare Test"},
	  {icon:"ü§ñ", desc:"Pretend your Wi-Fi is lagging. Loop your phrases.", meta:"Glitch Mode"},
	  {icon:"üìâ", desc:"Tell someone: ‚ÄòYou built like a PS2 default skin.‚Äô and start diss.", meta:"Visual Violation"},
	  {icon:"üçÜ", desc:"Drop an eggplant emoji in silence. Hold eye contact.", meta:"Emoji Ambush"},
	  {icon:"üó£Ô∏è", desc:"Whisper ‚ÄòI'm gay‚Äô every 10 seconds for a minute, louder each time.", meta:"Fa* Whisperer"},
	  {icon:"üì±", desc:"Accuse someone of using ChatGPT to flirt and start beef for 30s.", meta:"Bot Hunter"},
	  {icon:"üßÉ", desc:"Ask: ‚ÄòYou off the lean or just always this slow?‚Äô", meta:"Lean Detective"},
	  {icon:"ü§°", desc:"Say: ‚ÄòRatio + L + you fell off.‚Äô Smile sweetly.", meta:"Troll Ritual"},
	  {icon:"ü•∂", desc:"Say: ‚ÄòI get bi*ches‚Äô with zero conviction. Wait for others opinion.", meta:"No Rizz Challenge"},
	  {icon:"ü´µ", desc:"Call someone a background character. Keep narrating them.", meta:"NPC Narrator"},
	  {icon:"ü´•", desc:"Freeze mid-sentence like you lost signal. Stay frozen.", meta:"IRL Lag Spike"},
	  {icon:"ü•∑", desc:"Pretend you‚Äôre banned in 12 countries for your nationality. List fake reasons.", meta:"Global Menace"},
	  {icon:"üé§", desc:"Drop a bar that‚Äôs fire and problematic. Mic drop.", meta:"Rapper Cancelled"},
	  {icon:"üßü", desc:"Repeat: ‚ÄòBro?‚Äô in increasing volume until they break.", meta:"Zombie Loop"},
	  {icon:"üí£", desc:"Say: ‚ÄòUnpopular opinion: respect is overrated.‚Äô and defend that idea.", meta:"Cancel Me Starter"},
	  {icon:"ü¶¶", desc:"Accuse someone of being from Ohio. Refuse to elaborate.", meta:"Ohio TOS Violation"},
	  {icon:"üíÄ", desc:"Say: ‚ÄòI'm not racist, but‚Ä¶‚Äô and drop a harmless fact.", meta:"Bait Switch"},
	  {icon:"üîä", desc:"Yell: ‚ÄòTOXIC ALERT‚Äô every time someone speak.", meta:"Toxic Radar"},
	  {icon:"üß¢", desc:"Lie about everything you say for 30 seconds.", meta:"Gaslight Gamer"},
	  {icon:"üß©", desc:"Say: ‚ÄòYou give Roblox admin energy.‚Äô", meta:"Cringe Analyst"},
	  {icon:"ü™ô", desc:"Ask how much they‚Äôd sell their dignity for.", meta:"Moral Marketplace"},
	  {icon:"üò¥", desc:"Snore mid-answer. Deny it aggressively.", meta:"Sleep Tank"},
	  {icon:"üëë", desc:"Brag like you from hood, throw up fake gang sign.", meta:"Gang Chaser"},
	  {icon:"üì£", desc:"Shout ‚ÄòL Take‚Äô after they answer any question.", meta:"Debate Demon"},
	  {icon:"üëπ", desc:"Make someone CRASHOUT.", meta:"Debate Demon"},
	  {icon:"üí®", desc:"Rip a vape for 10 seconds.", meta:"Cloud Cringe"},
	  {icon:"üòà", desc:"React to everything someone say with passive aggression.", meta:"Daemon time"},
	  {icon:"ü§Ø", desc:"Ask someone: ‚ÄòIs water wet or dry?‚Äô and elaborate for 5 minutes.", meta:"Hood Research Department"},
	  {icon:"üêç", desc:"Speak like a snake for no reason. Hiss occasionally.", meta:"Sssus"},
	  {icon:"‚ú°Ô∏è", desc:"Act jewish for 30 seconds.", meta:"Bank CEO"},
	  {icon:"üßä", desc:"Roast someone drip. Say: ‚ÄòYou're Cheugy AF.‚Äô", meta:"Style Violation"},
	  {icon:"üëπ", desc:"Speak in a different nationality slang or accent for 30 seconds.‚Äô", meta:"Evil Era"},
	  {icon:"üé≠", desc:"Imitate cry for 30 seconds.", meta:"Sorry Act"},
	  {icon:"üï∫", desc:"Accuse someone of being too much 'Ohio energy,' then ask where their cows are.", meta:"Ohio Roast"},
	  {icon:"üáÆüá≥", desc:"Make a fake Indian accent for 30 seconds.", meta:"Masala Confusion"},
	  {icon:"üíç", desc:"Claim you're their long-lost Jewish cousin showing up unannounced.", meta:"Cousin Surprise"},
	  {icon:"ü•ä", desc:"Challenge someone to a virtual beef.", meta:"Streamer Beef"},
	  {icon:"üß†", desc:"Ask: ‚ÄòSpell Semitic backwards quickly. Don‚Äôt mess up.‚Äô", meta:"Word Trap"},
	  {icon:"üí£", desc:"Ask someone if they were: ‚ÄòSold Down The River.‚Äô", meta:"Spice Take"},
	  {icon:"ü¶π", desc:"Roleplay as a canceled influencer offering shady sponsorships.", meta:"Cancelled Merchant"},
	  {icon:"üò∑", desc:"Pretend you have a rare virus named after them. Panic.", meta:"Virus Bait"},
	  {icon:"üå∂Ô∏è", desc:"Tell a girl your rizz is so spicy it‚Äôs illegal in 3 states.", meta:"Spicy Warning"},
	  {icon:"üïµÔ∏è", desc:"Pretend to be a Nazi hunter asking about their ancestors.", meta:"Ancestor Hunt"},
	  {icon:"ü¶á", desc:"Pretend you're their online stalker quoting old tweets.", meta:"Stalker Roast"},
	  {icon:"üêç", desc:"Ssssspeak like a snake when accusing them of being fake.", meta:"Sneaky Sus"},
	  {icon:"üö®", desc:"Act like DEA calling about their fruit pun jokes.", meta:"Fruit Smash"},
	  {icon:"üçë", desc:"Flirt with fruit puns: ‚ÄòYour peach game is strong.‚Äô", meta:"Peach Rizz"},
	  {icon:"ü¶Å", desc:"Announce you‚Äôre the King of streaming platforms; roar on mic.", meta:"King Riff"},
	  {icon:"üé§", desc:"Perform a roast rap about their nationality and deny it‚Äôs racist.", meta:"Racist Rap?"},
	  {icon:"üì£", desc:"Crash out on random person", meta:"Local Crashout"},
	  {icon:"ü™û", desc:"Say: ‚ÄòMirror test ‚Äì repeat everything I say but more edgy.‚Äô", meta:"Mirror Challenge"},
	  {icon:"ü™û", desc:"Say: ‚ÄòMirror test ‚Äì repeat everything I do.‚Äô Act goofy.", meta:"Mirror Challenge2"},
	  {icon:"ü™ë", desc:"Act like a cocky interviewer asking dumb personal questions.", meta:"Mock Interview"},
	  {icon:"üí°", desc:"Roast someone mixing 2 different languages.‚Äô", meta:"Multilingual Roast"},
	  {icon:"üß®", desc:"Tell bomb joke that will make laugh random person", meta:"Joke Bomber"},
	  {icon:"ü•ä", desc:"Offer fake boxing match for clout. Trash-talk.", meta:"Clout Fight"},
    ];

    // -- Game logic
    let passCount = 0, lastPrank = -1, lastPrankedAt = 0, botStrikes = 0;
    const MIN_PRANK_TIME = 1200 + Math.floor(Math.random()*1300);

	// --- Shadowban Anti-botting Logic ---
	let shadowbanUntil = +(localStorage.getItem("bananaShadowbanUntil") || 0);


	let clickTimestamps = []; // Holds the last N click timestamps
	let shadowbanWarnActive = false; // NEW: tracks if warning is already showing

	const MAX_CLICKS = 30;      // ban if more than this...
	const CLICK_WINDOW = 10000; // ...in this many ms (10s)
	const BAN_DURATION = 24*60*60*1000; // 24 hours in ms (change if you want)

	function recordClickAndCheckBan() {
	  const now = Date.now();
	  // Remove old clicks
	  clickTimestamps = clickTimestamps.filter(ts => now - ts < CLICK_WINDOW);
	  clickTimestamps.push(now);

	  if (clickTimestamps.length >= MAX_CLICKS) {
		shadowbanUntil = now + BAN_DURATION;
		localStorage.setItem("bananaShadowbanUntil", shadowbanUntil);
		setFirebaseShadowban(deviceId, shadowbanUntil, "bot"); // Save to Firebase
		clickTimestamps = [];
		showWarn(`You are shadowbanned for 24h for spamming!`, 5000);
		return true;
	  }
	  return false;
	}

	// Timer display for shadowban left
	function shadowbanTimerTick() {
	  shadowbanWarnActive = true;
	  if (Date.now() < shadowbanUntil) {
		const left = shadowbanUntil - Date.now();
		const h = Math.floor(left/3600000), m = Math.floor((left%3600000)/60000)%60, s = Math.floor((left%60000)/1000);
		let warn = document.getElementById('nicknameWarn');
		warn.style.display = "block";
		warn.innerHTML = `‚è≥ Shadowbanned for <b>${h}h ${m}m ${s}s</b>`;
		setPrankButtonsDisabled(true);
		setTimeout(shadowbanTimerTick, 1000);
	  } else {
		let warn = document.getElementById('nicknameWarn');
		warn.style.display = "none";
		warn.innerHTML = "";
		shadowbanWarnActive = false;
		setPrankButtonsDisabled(false);
	  }
	}



    function getRank(level, xp) {
      if(level>=50) return "Cuff";
      if(level>=40) return "Banana King";
      if(level>=30) return "Clout Demon";
      if(level>=25) return "Speedrunner";
      if(level>=20) return "Discord Kitten";
      if(level>=17) return "NPC Mod";
      if(level>=13) return "Rizzler";
      if(level>=10) return "Ohio Legend";
      if(level>=7)  return "Sussy Baka";
      if(level>=5)  return "Ratio Demon";
      if(level>=3)  return "Down Bad";
      return "Peasant";
    }
    function getRankBadge(rank) {
	  if(rank=="Cuff") return '<span class="badge cuff">üî¥ Cuff</span>';
      if(rank=="Banana King") return '<span class="badge king">üçå King</span>';
      if(rank=="Clout Demon") return '<span class="badge sussy">Clout Demon üòà</span>';
      if(rank=="Speedrunner") return '<span class="badge goat">Speedrunner üíÄ</span>';
      if(rank=="Discord Kitten") return '<span class="badge kitten">Discord Kitten üê±</span>';
      if(rank=="NPC Mod") return '<span class="badge npc">NPC Mod üíª</span>';
      if(rank=="Rizzler") return '<span class="badge sussy">Rizzler üòè</span>';
      if(rank=="Ohio Legend") return '<span class="badge ohio">Ohio Legend ü¶¶</span>';
      if(rank=="Sussy Baka") return '<span class="badge sussy">Sussy Baka ü´•</span>';
      if(rank=="Ratio Demon") return '<span class="badge ratio">Ratio Demon üìâ</span>';
      if(rank=="Down Bad") return '<span class="badge downbad">Down Bad ü§°</span>';
      return '<span class="badge loser">Peasant ü•≤</span>';
    }

    function updateBars() {
      state.rank = getRank(state.level||1, state.xp);
      document.getElementById('streakArea').innerHTML = `üî• Streak: <b>${state.streak}</b> | üèÖ High: ${state.high}`;
      document.getElementById('levelArea').innerHTML = `${getRankBadge(state.rank)} üçå Level: <b>${state.level||1}</b> <span style="color:#98ffe0;font-weight:600;">(XP: ${state.xp})</span>`;
      updateAvatarUI();
    }

    // --- BEGIN NEW: Online Counter ---
    let onlineUsersSet = new Set();
	async function updatePresence() {
	  const myRef = ref(db, `presence/${currentUid}`);
	  await set(myRef, { online: true, t: Date.now() });
	  setTimeout(() => set(myRef, { online: false, t: Date.now() }), 45000);
	}
	

    // Count online users (last 45s)
    function watchOnlineUsers() {
      const presenceRef = ref(db, "presence");
      onValue(presenceRef, snap => {
        let count = 0;
        let now = Date.now();
        snap.forEach(child => {
          const v = child.val();
          if (v && v.online && now - v.t < 45000) count++;
        });
        document.getElementById('onlineNum').innerHTML = "Online: " + count;
      });
    }

    // --- END NEW: Online Counter ---

    // --- MODAL/CONFETTI/SOCIAL SHARING SYSTEM ---
    // Simple confetti for the modal
	function startPersistentConfettiModal(parent) {
	  parent.innerHTML = '';
	  let running = true;
	  function dropConfetti() {
		if (!running) return;
		const emoji = Math.random() < 0.6 ? "üçå" : (Math.random() < 0.5 ? "üèÜ" : "ü•á");
		let span = document.createElement('span');
		span.textContent = emoji;
		const left = Math.random() * 97;
		span.style = `
		  position: absolute; left: ${left}%; top: -36px; z-index:0;
		  font-size: ${18 + Math.random()*18}px;
		  opacity: ${0.37 + Math.random()*0.5};
		  pointer-events: none;
		  filter: drop-shadow(0 0 8px #ffd84d80);
		  animation: confettifall 2.4s linear forwards;
		`;
		parent.appendChild(span);
		setTimeout(() => { if (span.parentNode) span.parentNode.removeChild(span); }, 2420);
		if (running) setTimeout(dropConfetti, 160 + Math.random()*210);
	  }
	  dropConfetti();
	  parent._stopConfetti = () => { running = false; parent.innerHTML = ''; };
	}

    // Modal toast
    function showToast(msg) {
      const prev = document.getElementById('share-toast');
      if (prev) prev.remove();
      let toast = document.createElement('div');
      toast.className = 'share-toast';
      toast.id = 'share-toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(),2200);
    }

    // Share Modal
    async function showShareModal(level, xp, avatar, nickname) {
      const mount = document.getElementById('shareModalMount');
      mount.innerHTML = `
        <div class="share-modal-bg" id="shareModalBg">
          <div class="share-modal" id="shareModal">
            <button class="share-modal-close" onclick="window.closeShareModal()">√ó</button>
            <div class="level-trophy">üèÜüçå</div>
            <h2 style="margin:0;font-size:2.2em;color:#ffe46c;text-shadow:0 2px 18px #fbda618a;">LEVEL UP!</h2>
            <div style="margin-top:7px;margin-bottom:12px;font-size:1.24em;font-weight:bold;color:#55f191;">${avatar} <span style="color:#ffe46c;">${nickname}</span></div>
            <div style="margin-bottom:9px;font-size:1.14em;"><b>Level ${level}</b> ‚Äî <span style="color:#ffe46c;">XP:</span> ${xp}</div>
            <div class="banana-confetti" id="bananaConfettiModal"></div>
            <div class="share-modal-btns">
              <button class="x" onclick="window.shareToX(${level})">Share to X (Twitter)</button>
              <button class="copytext" onclick="window.copyLevelupText(${level},${xp})">Copy Share Text</button>
              <button class="link" onclick="window.copyLevelupLink()">Copy Game Link</button>
              <button class="download" onclick="window.downloadLevelupScreenshot()">Download Screenshot</button>
              <button class="copyimg" onclick="window.copyLevelupScreenshot()">Copy Screenshot (Chrome only)</button>
              <button style="background:#3a2d54;color:#ffe46c;" onclick="window.closeShareModal()">Close</button>
            </div>
          </div>
        </div>
      `;
      // Animate confetti in modal
      setTimeout(()=>startPersistentConfettiModal(document.getElementById('bananaConfettiModal')), 60);
      // Attach window-scoped helpers for the modal
		window.closeShareModal = function() {
		  const c = document.getElementById('bananaConfettiModal');
		  if (c && c._stopConfetti) c._stopConfetti();
		  mount.innerHTML = "";
		}

      window.copyLevelupLink = function() {
        navigator.clipboard.writeText(window.location.href);
        showToast("Copied game link!");
      }
      window.copyLevelupText = function(level,xp) {
        navigator.clipboard.writeText(`üî• I just reached Level ${level} (${xp} XP) on MONKEYY.APP! üçå\n${window.location.href}`);
        showToast("Copied share text!");
      }
      window.shareToX = function(level) {
        const msg = encodeURIComponent(`I just reached Level ${level} on MONKEYY.APP üçå #BananaBoard\n${window.location.href}`);
        window.open("https://twitter.com/intent/tweet?text="+msg,'_blank');
      }
      // Screenshot logic: capture .main area
		window.downloadLevelupScreenshot = function() {
		  html2canvas(document.getElementById('shareModal'), {backgroundColor: null, logging: false}).then(canvas=>{
			let l = document.createElement('a');
			l.href = canvas.toDataURL();
			l.download = `banana-levelup-${level}.png`;
			l.click();
			showToast("Downloaded level up screenshot!");
		  });
		}
		window.copyLevelupScreenshot = function() {
		  html2canvas(document.getElementById('shareModal'), {backgroundColor: null, logging: false}).then(canvas=>{
			canvas.toBlob(blob=>{
			  if (navigator.clipboard && navigator.clipboard.write) {
				const item = new ClipboardItem({ "image/png": blob });
				navigator.clipboard.write([item]);
				showToast("Copied screenshot! (try Chrome)");
			  } else {
				showToast("Copy image not supported!");
			  }
			});
		  });
		}

    }

    // --- MOD: MODERNIZED LevelUp Modal & persistent share
    function showLevelup(level) {
      let prev = document.getElementById('shareModalBg');
      if(prev) prev.remove();
      // Play sounds & confetti
      if (!isMuted) document.getElementById('soundLevelUp').play();
      if (!isMuted && Math.random() > 0.5) document.getElementById('soundMonkey1').play();
      else if (!isMuted) document.getElementById('soundMonkey2').play();
      updateAvatarUI(true);
      // Modern persistent modal
      showShareModal(level, state.xp, getRankAvatar(getRank(level,state.xp)), nickname);
    }

    function saveLocal() {
      localStorage.setItem("bananaState", JSON.stringify(state));
      localStorage.setItem("bananaNick", nickname);
      localStorage.setItem("bananaAvatar", avatar);
	  localStorage.setItem("bananaLastDayKey", todayKey);
    }
    function showWarn(msg, ms=1800) {
      let w = document.getElementById('nicknameWarn');
      w.innerHTML = msg;
      w.style.display = "block";
      w.classList.remove("hide");
      setTimeout(()=>{ w.classList.add("hide"); }, ms);
      setTimeout(()=>{ w.style.display="none"; w.classList.remove("hide"); }, ms+600);
    }

    // Extra confetti for leaderboard/flex
    function flexConfetti(emoji="üëë") {
      for (let i = 0; i < 18; ++i) {
        setTimeout(()=>{
          let b = document.createElement("div");
          b.className = "confetti";
          b.textContent = emoji;
          b.style.left = Math.random()*100+"vw";
          b.style.top = "0vh";
          b.style.fontSize = (28+Math.random()*26)+"px";
          b.style.opacity = 1;
          document.body.appendChild(b);
          let anim = b.animate([
            {top:"0vh", opacity:1, transform:`rotate(${Math.random()*180-90}deg)`},
            {top:"100vh", opacity:0, transform:`rotate(${Math.random()*360-180}deg)`}
          ], {duration: 1800+Math.random()*900});
          anim.onfinish = ()=>b.remove();
        }, i*50+Math.random()*100);
      }
    }

    function bananaConfetti(emoji="üçå") {
      for (let i = 0; i < 12; ++i) {
        setTimeout(()=>{
          let b = document.createElement("div");
          b.className = "confetti";
          b.textContent = emoji;
          b.style.left = Math.random()*100+"vw";
          b.style.top = "0vh";
          b.style.fontSize = (26+Math.random()*26)+"px";
          b.style.opacity = 1;
          document.body.appendChild(b);
          let anim = b.animate([
            {top:"0vh", opacity:1, transform:`rotate(${Math.random()*180-90}deg)`},
            {top:"100vh", opacity:0, transform:`rotate(${Math.random()*360-180}deg)`}
          ], {duration: 1500+Math.random()*900});
          anim.onfinish = ()=>b.remove();
        }, i*80+Math.random()*100);
      }
    }

    function nextPrank() {
      let idx;
      do { idx = Math.floor(Math.random() * pranks.length); } while(idx === lastPrank);
      lastPrank = idx;
      let prank = pranks[idx];
      document.getElementById('prankArea').innerHTML = `
        <div class="prank-box">
          <div class="prank-icon">${prank.icon || "üé≤"}</div>
          <div class="prank-desc">${prank.desc || "No prank loaded!"}</div>
          <div class="prank-meta">${prank.meta || ""}</div>
          <div class="prank-btn-row">
            <button class="prank-action-btn pranked" id="prankBtn">PRANKED! üíÄ</button>
            <button class="prank-action-btn pass" id="passBtn">PASS üçÜ</button>
          </div>
          <button class="again-btn" id="nextBtn">NEXT PRANK</button>
        </div>
      `;
      document.getElementById('prankBtn').onclick = prankedHandler;
      document.getElementById('passBtn').onclick = passHandler;
      document.getElementById('nextBtn').onclick = nextPrank;
	  setPrankButtonsDisabled(Date.now() < shadowbanUntil);
    }

	function prankedHandler() {
	  // SHADOWBAN CHECK
	  if (Date.now() < shadowbanUntil) {
		if (!shadowbanWarnActive) {
		  shadowbanWarnActive = true;
		  shadowbanTimerTick();
		}
		return;
	  }
	  if (recordClickAndCheckBan()) return;
	  shadowbanWarnActive = false; // not banned, clear flag

      const now = Date.now();
      if(now - lastPrankedAt < MIN_PRANK_TIME) {
        botStrikes += 1;
        state.xp = Math.max(0, state.xp-5);
        showWarn("TOO FAST! -5 XP", 1300);
        updateBars();
        return;
      }
      lastPrankedAt = now;
      state.streak++;
      passCount = 0;
      state.xp += 2 + Math.floor(Math.random()*3) + Math.max(0, Math.floor(state.streak/10)); // Streak XP bonus
      let oldLevel = state.level;
      state.level = Math.floor(Math.sqrt(state.xp/12)) + 1;
      if(state.level > oldLevel) showLevelup(state.level);
      if(state.streak>state.high) state.high = state.streak;
      updateBars();
      saveLocal();
      updateLeaderboardLive();
      if (!isMuted) document.getElementById('soundPranked').play();
	  document.getElementById('nicknameInput').value = nickname;
      // Random monkey sound for more hype
      if (!isMuted && Math.random() > 0.55) document.getElementById('soundMonkey1').play();
      if (!isMuted && Math.random() < 0.22) document.getElementById('soundMonkey2').play();
      bananaConfetti("üçå");
      nextPrank();
    }

    function passHandler() {
	  // SHADOWBAN CHECK
	  if (Date.now() < shadowbanUntil) {
		if (!shadowbanWarnActive) {
		  shadowbanWarnActive = true;
		  shadowbanTimerTick();
		}
		return;
	  }
	  if (recordClickAndCheckBan()) return;
	  shadowbanWarnActive = false; // not banned, clear flag

      passCount++;
      state.streak = 0;
      state.xp = Math.max(0, state.xp-5);
      showWarn(`Passed! -5 XP, streak reset.`, 1800);
      if (!isMuted) document.getElementById('soundPass').play();
	  document.getElementById('nicknameInput').value = nickname;
      bananaConfetti("üçÜ");
      updateBars();
      saveLocal();
      updateLeaderboardLive();
      nextPrank();
    }

    function resetSession() {
      state.streak = 0;
      state.xp = 0;
      state.level = 1;
      passCount = 0;
      botStrikes = 0;
      lastPrankedAt = 0;
      updateBars();
      saveLocal();
      updateLeaderboardLive();
      document.getElementById('prankArea').innerHTML = `<div style="color:#5ff0c5; font-weight:bold; margin-top:20px;">Session ended. Start again or check the daily leaderboard!</div>`;
    }
	
	function setPrankButtonsDisabled(disabled) {
	  let prankBtn = document.getElementById('prankBtn');
	  let passBtn = document.getElementById('passBtn');
	  if(prankBtn) prankBtn.disabled = disabled;
	  if(passBtn) passBtn.disabled = disabled;
	}


	// -- Realtime leaderboard, always update only YOUR deviceId
	async function updateLeaderboardLive() {
	  // Prevent writing to leaderboard if:
	  // - nickname is missing or not allowed
	  // - OR level is missing, zero or less
	  // - OR XP is negative (optional sanity)
	  if (!nickname || !cleanNickname(nickname) || !state.level || state.level < 1 || state.xp < 0) return;

	  state.rank = getRank(state.level || 1, state.xp);
	  avatar = getRankAvatar(state.rank);
	  const data = {
		nickname: nickname,
		streak: state.streak,
		xp: state.xp,
		level: state.level,
		high: state.high,
		time: Date.now(),
		avatar: avatar,
		rank: state.rank
	  };
	  await set(ref(db, `leaderboard/${todayKey}/${currentUid}`), data);
	  setTimeout(showLeaderboard, 200);
	}



	async function getLeaderboard(dayKey) {
	  const snap = await get(ref(db, 'leaderboard/' + dayKey));
	  let arr = [];
	  snap.forEach(child => {
		const v = child.val();
		// Only add valid entries
		if (v.nickname && v.nickname.length >= 3 && v.level >= 1) arr.push(v);
	  });
	  // Sort: level DESC, xp DESC, streak DESC, time DESC
	  arr = arr.sort((a, b) => {
		if (b.level !== a.level) return b.level - a.level;
		if (b.xp !== a.xp) return b.xp - a.xp;
		if (b.streak !== a.streak) return b.streak - a.streak;
		return b.time - a.time;
	  });
	  // Remove duplicate nicknames (keep highest)
	  const seen = new Set();
	  arr = arr.filter(v => {
		if (seen.has(v.nickname.toLowerCase())) return false;
		seen.add(v.nickname.toLowerCase());
		return true;
	  });
	  return arr.slice(0, 3); // Only show top 3
	}

	async function showLeaderboard() {
	  const today = await getLeaderboard(todayKey);
	  const yesterday = await getLeaderboard(yesterdayKey);

	  let html = `<div class="leaderboard-container">`;

	  // Consistent sticky header
	  html += `
		<div class="leader-title">
		  <span style="font-size:1.25em;">üèÜ Banana Board</span> 
		  <span style="color:#ffe46c;font-weight:700;font-size:1.05em;">‚Äî Top Levels Today</span>
		</div>
	  `;

	  if (today.length === 0) {
		html += `<div style="color:#ffe46c;text-align:center;margin:12px 0;font-size:1.14em;">Nobody's on the board yet. Be the first to flex!</div>`;
	  } else {
		html += `<div class="leaderboard-table">`;
		today.slice(0, 3).forEach((p, i) => {
		  html += `
			<div class="leaderboard-row${i === 0 ? ' top1' : ''}${p.nickname === nickname ? ' your' : ''}">
			  <span class="spot">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.'}</span>
			  <span class="avatar">${getRankAvatar(p.rank)}</span>
			  <span class="name">${p.nickname}</span>
			  ${p.nickname === nickname ? '<span class="badge you">YOU</span>' : ''}
			  ${i === 0 ? '<span class="badge king">KING</span>' : ''}
			  <span class="meta">
				<span class="level">Lv. ${p.level}</span>
				<span class="xp">XP: ${p.xp}</span>
				<span class="streak">üî• ${p.streak}</span>
			  </span>
			</div>
		  `;
		});
		html += `</div>`; // .leaderboard-table
	  }
	  // Yesterday's king (optional)
	  if (yesterday.length) {
		const king = yesterday[0];
		html += `<div style="margin:10px 0 0 0;text-align:center;font-size:1em;color:#ffd84d;">
		  üëë <span style="color:#ffe46c;">Yesterday's Banana King:</span> 
		  <span class="avatar">${getRankAvatar(king.rank)}</span> 
		  <b>${king.nickname}</b>
		  <span class="meta" style="display:inline-flex;margin-left:5px;">
			<span class="level">Lv. ${king.level}</span>
			<span class="xp">XP: ${king.xp}</span>
			<span class="streak">üî• ${king.streak}</span>
		  </span>
		</div>`;
	  }
	  html += `</div>`;
	  document.getElementById('leaderboardSticky').innerHTML = html;
	  // Confetti for #1 spot
	  if (today.length && today[0].nickname === nickname) {
		flexConfetti("üëë");
		if (!isMuted && Math.random() > 0.5) document.getElementById('soundMonkey1').play();
	  }
	}


    // -- Start button/flow
    document.getElementById('startBtn').onclick = function() {
      document.getElementById('startArea').style.display = "none";
      document.getElementById('prankArea').style.display = "block";
      updateBars();
      nextPrank();
    };

	document.addEventListener('keydown', function(e) {
	  if (e.key === "Enter" && document.getElementById('startArea').style.display !== "none") {
		document.getElementById('startBtn').click();
	  }
	});


    document.addEventListener('DOMContentLoaded', ()=>{
      updateBars();
      showLeaderboard();
      setInterval(showLeaderboard, 5000);
      setInterval(updateBars, 3300);
    });
	

	
	if (Date.now() < shadowbanUntil) {
	  shadowbanTimerTick();
	}
	
	// Keyboard accessibility for modal
	document.addEventListener('keydown', function(e) {
	  const modal = document.getElementById('shareModalBg');
	  if (modal && e.key === "Escape") {
		if (window.closeShareModal) window.closeShareModal();
	  }
	});
  </script>
</body>
</html>
